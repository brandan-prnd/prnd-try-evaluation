<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íšŒê³  Try í‰ê°€</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f8f9fa;
            line-height: 1.6;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .main-container {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .evaluator-section {
            margin-bottom: 30px;
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }
        
        .evaluator-section label {
            display: block;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 12px;
            font-size: 1.15rem;
        }
        
        .evaluator-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        
        .evaluator-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .user-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #e1e8ed;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .user-option {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f8f9fa;
            transition: background-color 0.2s ease;
        }
        
        .user-option:hover {
            background-color: #f8f9fa;
        }
        
        .user-option:last-child {
            border-bottom: none;
        }
        
        .user-name {
            font-weight: 500;
            color: #2c3e50;
        }
        
        .user-email {
            font-size: 0.85rem;
            color: #7f8c8d;
            margin-top: 2px;
        }
        
        
        .tries-title {
            color: #2c3e50;
            margin-bottom: 25px;
            font-size: 1.5rem;
            font-weight: 600;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 10px;
        }
        
        .try-item {
            border: 2px solid #ecf0f1;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            background: #fafbfc;
        }
        
        .try-item:hover {
            border-color: #bdc3c7;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        .try-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }
        
        .try-description {
            color: #7f8c8d;
            margin-bottom: 15px;
            font-size: 0.95rem;
        }
        
        .rating-options {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .rating-option {
            flex: 1;
            min-width: 180px;
        }
        
        .rating-option input[type="radio"] {
            display: none;
        }
        
        .rating-label {
            display: block;
            padding: 12px 16px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 0.95rem;
        }
        
        .rating-option input[type="radio"]:checked + .rating-label {
            background: #3498db;
            color: white;
            border-color: #3498db;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
        }
        
        .rating-label:hover {
            border-color: #3498db;
            background: rgba(52, 152, 219, 0.05);
        }
        
        .rating-excellent {
            border-color: #27ae60 !important;
        }
        
        .rating-excellent:hover {
            background: rgba(39, 174, 96, 0.05) !important;
        }
        
        .rating-option input[type="radio"]:checked + .rating-excellent {
            background: #27ae60 !important;
            border-color: #27ae60 !important;
        }
        
        .rating-average {
            border-color: #f39c12 !important;
        }
        
        .rating-average:hover {
            background: rgba(243, 156, 18, 0.05) !important;
        }
        
        .rating-option input[type="radio"]:checked + .rating-average {
            background: #f39c12 !important;
            border-color: #f39c12 !important;
        }
        
        .rating-poor {
            border-color: #e74c3c !important;
        }
        
        .rating-poor:hover {
            background: rgba(231, 76, 60, 0.05) !important;
        }
        
        .rating-option input[type="radio"]:checked + .rating-poor {
            background: #e74c3c !important;
            border-color: #e74c3c !important;
        }
        
        
        .submit-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 200px;
        }
        
        .submit-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }
        
        .submit-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
            font-size: 1.1rem;
        }
        
        .error {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .success {
            background: #27ae60;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        @media (max-width: 768px) {
            .rating-options {
                flex-direction: column;
            }
            
            .rating-option {
                min-width: auto;
            }
            
            .container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-container">
            <h1 style="color: #2c3e50; text-align: center; margin-bottom: 30px; font-size: 2.2rem;">íšŒê³  Try í‰ê°€</h1>
            
            <div class="evaluator-section">
                <label for="evaluator-search">í‰ê°€ì</label>
                <div class="user-select-container" style="position: relative;">
                    <input type="text" id="evaluator-search" class="evaluator-input" placeholder="ì´ë¦„ì„ ê²€ìƒ‰í•˜ì„¸ìš”." autocomplete="off">
                    <div id="user-dropdown" class="user-dropdown" style="display: none;"></div>
                    <input type="hidden" id="selected-user-id">
                    <input type="hidden" id="selected-user-name">
                </div>
            </div>
            
            <div class="evaluator-section">
                <label for="feature-search">ì§„í–‰í•œ í”¼ì³</label>
                <div class="feature-select-container" style="position: relative;">
                    <input type="text" id="feature-search" class="evaluator-input" placeholder="í”¼ì³ ì´ë¦„ì„ ê²€ìƒ‰í•˜ì„¸ìš”." autocomplete="off">
                    <div id="feature-dropdown" class="user-dropdown" style="display: none;"></div>
                    <input type="hidden" id="selected-feature-id">
                    <input type="hidden" id="selected-feature-name">
                    <input type="hidden" id="selected-feature-url">
                </div>
            </div>
            
            <div id="content-area">
                <div class="loading">Try ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
            
            <div class="submit-section" id="submit-section" style="display: none; text-align: center; margin-top: 30px; padding-top: 30px; border-top: 1px solid #ecf0f1;">
                <button class="submit-btn" id="submit-btn" onclick="submitEvaluations()">í‰ê°€ ì œì¶œ</button>
            </div>
        </div>
    </div>

    <script>
        let tries = [];
        let users = [];
        let features = [];
        let selectedRatings = {}; // ì„ íƒëœ í‰ê°€ë“¤ì„ ì¶”ì 
        
        async function loadUsers() {
            try {
                const response = await fetch('/api/users');
                users = await response.json();
                setupUserSearch();
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        async function loadFeatures() {
            try {
                setupFeatureSearch();
            } catch (error) {
                console.error('Error setting up feature search:', error);
            }
        }
        
        function setupUserSearch() {
            const searchInput = document.getElementById('evaluator-search');
            const dropdown = document.getElementById('user-dropdown');
            
            searchInput.addEventListener('input', function() {
                const query = this.value.toLowerCase().trim();
                const selectedUserName = document.getElementById('selected-user-name').value;
                
                // í˜„ì¬ ì…ë ¥ê°’ì´ ì„ íƒëœ ì‚¬ìš©ìëª…ê³¼ ë‹¤ë¥´ë©´ ì„ íƒ í•´ì œ
                if (this.value !== selectedUserName) {
                    document.getElementById('selected-user-id').value = '';
                    document.getElementById('selected-user-name').value = '';
                    updateSubmitButtonState();
                }
                
                // ì…ë ¥ í•„ë“œê°€ ë¹„ì–´ìˆìœ¼ë©´ ë“œë¡­ë‹¤ìš´ ìˆ¨ê¹€
                if (query.length === 0) {
                    dropdown.style.display = 'none';
                    return;
                }
                
                const filteredUsers = users.filter(user => 
                    user.name.toLowerCase().includes(query) || 
                    user.email.toLowerCase().includes(query)
                );
                
                console.log('Search query:', query);
                console.log('Filtered users:', filteredUsers);
                
                if (filteredUsers.length > 0) {
                    dropdown.innerHTML = filteredUsers.map(user => `
                        <div class="user-option" onclick="selectUser('${user.id}', '${user.name}')">
                            <div class="user-name">${user.name}</div>
                            <div class="user-email">${user.email}</div>
                        </div>
                    `).join('');
                    dropdown.style.display = 'block';
                } else {
                    dropdown.style.display = 'none';
                }
            });
            
            // ì™¸ë¶€ í´ë¦­ì‹œ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
            document.addEventListener('click', function(event) {
                if (!event.target.closest('.user-select-container')) {
                    dropdown.style.display = 'none';
                }
            });
        }
        
        function selectUser(userId, userName) {
            document.getElementById('evaluator-search').value = userName;
            document.getElementById('selected-user-id').value = userId;
            document.getElementById('selected-user-name').value = userName;
            document.getElementById('user-dropdown').style.display = 'none';
            updateSubmitButtonState();
        }

        function setupFeatureSearch() {
            const searchInput = document.getElementById('feature-search');
            const dropdown = document.getElementById('feature-dropdown');
            let debounceTimeout;
            let abortController;
            
            searchInput.addEventListener('input', function() {
                const query = this.value.trim();
                const selectedFeatureName = document.getElementById('selected-feature-name').value;
                
                // í˜„ì¬ ì…ë ¥ê°’ì´ ì„ íƒëœ í”¼ì²˜ëª…ê³¼ ë‹¤ë¥´ë©´ ì„ íƒ í•´ì œ
                if (this.value !== selectedFeatureName) {
                    document.getElementById('selected-feature-id').value = '';
                    document.getElementById('selected-feature-name').value = '';
                    document.getElementById('selected-feature-url').value = '';
                    updateSubmitButtonState();
                }
                
                // ì…ë ¥ í•„ë“œê°€ ë¹„ì–´ìˆìœ¼ë©´ ë“œë¡­ë‹¤ìš´ ìˆ¨ê¹€
                if (query.length === 0) {
                    dropdown.style.display = 'none';
                    return;
                }

                clearTimeout(debounceTimeout);
                
                if (abortController) {
                    abortController.abort();
                }
                
                dropdown.innerHTML = '<div class="user-option" style="color: #7f8c8d; font-style: italic;">ê²€ìƒ‰ ì¤‘...</div>';
                dropdown.style.display = 'block';
                
                debounceTimeout = setTimeout(async () => {
                    try {
                        abortController = new AbortController();
                        
                        const response = await fetch(`/api/features?q=${encodeURIComponent(query)}`, {
                            signal: abortController.signal
                        });
                        const filteredFeatures = await response.json();
                        
                        if (filteredFeatures.length > 0) {
                            dropdown.innerHTML = filteredFeatures.map(feature => `
                                <div class="user-option" onclick="selectFeature('${feature.id}', '${feature.title.replace(/'/g, "\\'")}', '${feature.url}')">
                                    <div class="user-name">${feature.title}</div>
                                </div>
                            `).join('');
                            dropdown.style.display = 'block';
                        } else {
                            dropdown.innerHTML = '<div class="user-option" style="color: #7f8c8d; font-style: italic;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                            dropdown.style.display = 'block';
                        }
                    } catch (error) {
                        if (error.name === 'AbortError') {
                            return;
                        }
                        console.error('Error searching features:', error);
                        dropdown.innerHTML = '<div class="user-option" style="color: #e74c3c; font-style: italic;">ê²€ìƒ‰ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
                        dropdown.style.display = 'block';
                    }
                }, 300);
            });
            
            // ì™¸ë¶€ í´ë¦­ì‹œ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
            document.addEventListener('click', function(event) {
                if (!event.target.closest('.feature-select-container')) {
                    dropdown.style.display = 'none';
                }
            });
        }

        function selectFeature(featureId, featureName, featureUrl) {
            document.getElementById('feature-search').value = featureName;
            document.getElementById('selected-feature-id').value = featureId;
            document.getElementById('selected-feature-name').value = featureName;
            document.getElementById('selected-feature-url').value = featureUrl;
            document.getElementById('feature-dropdown').style.display = 'none';
            updateSubmitButtonState();
        }
        
        async function loadTries() {
            try {
                const response = await fetch('/api/tries');
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                tries = data;
                renderTries();
            } catch (error) {
                document.getElementById('content-area').innerHTML = 
                    `<div class="error">Try ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}</div>`;
            }
        }
        
        function renderTries() {
            const contentArea = document.getElementById('content-area');
            const submitSection = document.getElementById('submit-section');
            
            if (tries.length === 0) {
                contentArea.innerHTML = '<div class="loading">í‰ê°€í•  Tryê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            const triesHtml = tries.map((tryItem, index) => `
                <div class="try-item">
                    <div class="try-title">${tryItem.title}</div>
                    <div class="try-description">${tryItem.description}</div>
                    <div class="rating-options">
                        <div class="rating-option">
                            <input type="radio" id="try-${index}-excellent" name="try-${index}" value="1" onclick="handleRatingClick(${index}, '1', this)">
                            <label for="try-${index}-excellent" class="rating-label rating-excellent">ì˜ ì§€ì¼°ì–´ìš” (100%)</label>
                        </div>
                        <div class="rating-option">
                            <input type="radio" id="try-${index}-average" name="try-${index}" value="0.5" onclick="handleRatingClick(${index}, '0.5', this)">
                            <label for="try-${index}-average" class="rating-label rating-average">ë¶€ë¶„ì ìœ¼ë¡œ ì§€ì¼°ì–´ìš” (50%)</label>
                        </div>
                        <div class="rating-option">
                            <input type="radio" id="try-${index}-poor" name="try-${index}" value="0" onclick="handleRatingClick(${index}, '0', this)">
                            <label for="try-${index}-poor" class="rating-label rating-poor">ëª» ì§€ì¼°ì–´ìš” (0%)</label>
                        </div>
                    </div>
                    <div class="reason-section" style="margin-top: 15px;">
                        <label for="reason-${index}" style="display: block; font-weight: 500; color: #34495e; margin-bottom: 5px; font-size: 0.9rem;">í‰ê°€ ì´ìœ  (ì„ íƒì‚¬í•­)</label>
                        <textarea 
                            id="reason-${index}" 
                            placeholder="ìœ„ì™€ ê°™ì´ í‰ê°€í•˜ì‹  ì´ìœ ë¥¼ ì ì–´ì£¼ì„¸ìš”."
                            style="width: 100%; padding: 8px 12px; border: 1px solid #e1e8ed; border-radius: 6px; resize: vertical; min-height: 60px; font-family: inherit; font-size: 0.9rem;"
                        ></textarea>
                    </div>
                </div>
            `).join('');
            
            contentArea.innerHTML = `
                <h2 class="tries-title" style="margin-top: 30px;">í‰ê°€ ì¤‘ì¸ Try ëª©ë¡ (${tries.length}ê°œ)</h2>
                <div style="background: #e8f4fd; border-left: 4px solid #3498db; padding: 15px 20px; margin: 0 0 25px 0; border-radius: 0 8px 8px 0;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="color: #3498db; font-size: 1.1rem;">ğŸ’¡</div>
                        <span style="color: #2980b9; font-size: 0.95rem; font-weight: 500;">í‰ê°€ë¥¼ í•  ìˆ˜ ì—†ëŠ” TryëŠ” í‰ê°€í•˜ì§€ ì•Šì•„ë„ ë©ë‹ˆë‹¤.</span>
                    </div>
                </div>
                ${triesHtml}
            `;
            
            submitSection.style.display = 'block';
            updateSubmitButtonState();
        }
        
        function handleRatingClick(tryIndex, value, radioElement) {
            // ì´ë¯¸ ì„ íƒëœ í•­ëª©ì„ ë‹¤ì‹œ í´ë¦­í•˜ë©´ ì„ íƒ ì·¨ì†Œ
            if (selectedRatings[tryIndex] === value) {
                radioElement.checked = false;
                delete selectedRatings[tryIndex];
            } else {
                selectedRatings[tryIndex] = value;
            }
            updateSubmitButtonState();
        }
        
        function updateSubmitButtonState() {
            const submitBtn = document.getElementById('submit-btn');
            const evaluatorId = document.getElementById('selected-user-id').value;
            const hasAnySelection = Object.keys(selectedRatings).length > 0;
            
            if (evaluatorId && hasAnySelection) {
                submitBtn.disabled = false;
                submitBtn.style.background = '#3498db';
                submitBtn.style.cursor = 'pointer';
            } else {
                submitBtn.disabled = true;
                submitBtn.style.background = '#bdc3c7';
                submitBtn.style.cursor = 'not-allowed';
            }
        }
        
        async function submitEvaluations() {
            const evaluatorId = document.getElementById('selected-user-id').value;
            const evaluatorName = document.getElementById('selected-user-name').value;
            const featureName = document.getElementById('selected-feature-name').value;
            const featureUrl = document.getElementById('selected-feature-url').value;
            
            if (!evaluatorId) {
                alert('í‰ê°€ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ë²„íŠ¼ì´ ë¹„í™œì„±í™”ëœ ê²½ìš° ì œì¶œ ì¤‘ë‹¨
            const submitBtn = document.getElementById('submit-btn');
            if (submitBtn.disabled) {
                return;
            }
            
            const evaluations = [];
            
            // ì„ íƒëœ í‰ê°€ë§Œ ì œì¶œ
            Object.keys(selectedRatings).forEach(tryIndex => {
                const reasonTextarea = document.getElementById(`reason-${tryIndex}`);
                const reason = reasonTextarea ? reasonTextarea.value.trim() : "";
                
                evaluations.push({
                    tryId: tries[tryIndex].id,
                    score: parseFloat(selectedRatings[tryIndex]),
                    reason: reason
                });
            });
            
            if (evaluations.length === 0) {
                alert('ìµœì†Œ 1ê°œ ì´ìƒì˜ Tryë¥¼ í‰ê°€í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'ì œì¶œ ì¤‘...';
            
            try {
                const response = await fetch('/api/evaluate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        evaluatorId: evaluatorId,
                        evaluatorName: evaluatorName,
                        featureName: featureName,
                        featureUrl: featureUrl,
                        evaluations: evaluations
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    document.querySelector('.main-container').innerHTML = 
                        '<div style="text-align: center; padding: 60px 20px;"><div class="success" style="display: inline-block;">í‰ê°€ê°€ ì„±ê³µì ìœ¼ë¡œ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤!</div></div>';
                } else {
                    throw new Error(result.error || 'í‰ê°€ ì œì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                alert(`í‰ê°€ ì œì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}`);
                submitBtn.disabled = false;
                submitBtn.textContent = 'í‰ê°€ ì œì¶œ';
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            loadUsers();
            loadFeatures();
            loadTries();
        });
    </script>
</body>
</html>